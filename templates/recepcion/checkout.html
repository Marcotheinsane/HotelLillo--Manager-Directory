{% extends 'base.html' %}
{% block title %}Check-Out - {{ huesped.nombre }}{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto grid grid-cols-1 lg:grid-cols-2 gap-6">
    <!-- Información del huésped -->
    <div class="bg-white p-6 rounded shadow">
        <h2 class="text-xl font-semibold mb-3">Información del Huésped</h2>
        <p class="font-medium">{{ huesped.nombre }} {{ huesped.apellido }}</p>
        <p class="text-sm text-gray-600">Documento: {{ huesped.tipo_documento }} - {{ huesped.numero_documento }}</p>
        <p class="text-sm text-gray-600">Email: {{ huesped.email }}</p>
        <p class="text-sm text-gray-600">Teléfono: {{ huesped.telefono }}</p>

        <hr class="my-4">
        <p><strong>Habitación:</strong> {{ habitacion.numero }} — {{ habitacion.tipo }}</p>
        <p><strong>Fechas:</strong> {{ reserva.fecha_check_in }} → {{ reserva.fecha_check_out }}</p>
        <p><strong>Noches:</strong> {{ noches }}</p>
    </div>

    <!-- Facturación -->
    <div class="bg-white p-6 rounded shadow">
        <h2 class="text-xl font-semibold mb-3">Resumen de Facturación</h2>

        <form method="post" id="checkout-form">
            {% csrf_token %}

            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">Costo Habitación</label>
                <div class="flex items-center justify-between bg-gray-50 p-3 rounded">
                    <div>Tarifa x noches</div>
                    <div class="font-semibold">${{ costo_habitacion }}</div>
                </div>
            </div>

            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">Servicios</label>
                <div class="space-y-2">
                    {{ service_formset.management_form }}
                    {% for form in service_formset.forms %}
                    <div class="grid grid-cols-3 gap-2">
                        <div class="col-span-2">{{ form.nombre }}</div>
                        <div>{{ form.precio }}</div>
                    </div>
                    {% endfor %}
                </div>
                <p class="text-xs text-gray-500 mt-2">Agregue servicios usados por el huésped (min 0).</p>
            </div>

            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">Impuestos (%)</label>
                {{ form.impuestos }}
            </div>

            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">Notas</label>
                {{ form.notas }}
            </div>

            <div class="flex items-center justify-between mt-6">
                <button type="submit" name="calcular_total" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition-colors">
                    Calcular Total
                </button>
                <a href="{% url 'recepcion:seleccionar_huesped' %}" class="text-sm text-gray-600">Volver a la lista</a>
            </div>

            {% if resumen_listo %}
            <hr class="my-6 border-t-2 border-blue-200">
            <div id="resumen-seccion">
                <h3 class="text-lg font-semibold mb-2">Resumen a Pagar en Check-Out</h3>
                <div class="text-sm text-gray-800 space-y-2">
                    <div class="flex justify-between bg-gray-100 p-2 rounded">
                        <span>Costo Estancia</span>
                        <span class="font-medium">${{ pago_estancia|floatformat:2 }} (Ya pagado)</span>
                    </div>
                    <div class="flex justify-between p-2">
                        <span>Subtotal Servicios</span>
                        <span>${{ total_servicios|floatformat:2 }}</span>
                    </div>
                    <div class="flex justify-between p-2">
                        <span>Impuestos ({{ impuestos_pct }}%)</span>
                        <span>${{ impuestos_calculados|floatformat:2 }}</span>
                    </div>
                    <div class="flex justify-between font-bold text-lg bg-blue-100 text-blue-800 p-3 rounded mt-2">
                        <span>TOTAL A PAGAR AHORA</span>
                        <span>${{ total_a_pagar_checkout|floatformat:2 }}</span>
                    </div>
                </div>
                <button type="submit" name="confirmar_checkout" class="mt-4 w-full bg-green-600 text-white font-bold py-3 rounded-lg hover:bg-green-700 transition-colors">Confirmar Check-Out y Finalizar Estancia</button>
            </div>
            {% endif %}
        </form>

    </div>
</div>
{% endblock %}
